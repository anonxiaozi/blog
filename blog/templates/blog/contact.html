{% extends 'blog/base.html' %}
{% load static %}
{% block header %}
    <header class="masthead" style="background-image: url('{% static "blog/img/background/contact.jpg" %}')">
        <div class="overlay"></div>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-10 mx-auto">
                    <div class="page-heading">
                        <h1>Contact Me</h1>
                        <span class="subheading">邮件联系</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
{% endblock %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <p>嗨，交个朋友！交流一下！</p>
                <form name="sentMessage" id="contactForm" novalidate>
                    {% csrf_token %}
                    <div class="control-group">
                        <div class="form-group floating-label-form-group controls">
                            <label>Name</label>
                            <input type="text" class="form-control" placeholder="Name" id="name" required
                                   data-validation-required-message="Please enter your name.">
                            <p class="help-block text-danger"></p>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="form-group floating-label-form-group controls">
                            <label>Email Address</label>
                            <input type="email" class="form-control" placeholder="Email Address" id="email" required
                                   data-validation-required-message="Please enter your email address.">
                            <p class="help-block text-danger"></p>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="form-group col-xs-12 floating-label-form-group controls">
                            <label>Phone Number</label>
                            <input type="tel" class="form-control" placeholder="Phone Number" id="phone" required
                                   data-validation-required-message="Please enter your phone number.">
                            <p class="help-block text-danger"></p>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="form-group floating-label-form-group controls">
                            <label>Message</label>
                            <textarea rows="5" class="form-control" placeholder="Message" id="message" required
                                      data-validation-required-message="Please enter a message."></textarea>
                            <p class="help-block text-danger"></p>
                        </div>
                    </div>
                    <br>
                    <div id="success"></div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="sendMessageButton">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <hr>
{% endblock %}
{% block js %}
    <script src="{% static 'blog/js/jqBootstrapValidation.js' %}"></script>
    <script>
        $(function () {
            function loadSend() {
                $('#success').html("<div class='progress' style='margin-bottom: 10px;'><div class='progress-bar progress-bar-striped progress-bar-animated'\ " +
                    "id='load' role='progressbar' aria-valuenow='20' aria-valuemin='0' aria-valuemax='100' style='width: 20%'></div></div>");
                var self = $('#load');
                var i = 0;
                setInterval(function () {
                    self.css('width', i + '%');
                    i += 20;
                })
            }

            $("#contactForm input,#contactForm textarea").jqBootstrapValidation({
                preventSubmit: true,
                submitError: function ($form, event, errors) {
                    // additional error messages or events
                    console.log(errors)
                },
                submitSuccess: function ($form, event) {
                    event.preventDefault(); // prevent default submit behaviour
                    // get values from FORM
                    var name = $("input#name").val();
                    var email = $("input#email").val();
                    var phone = $("input#phone").val();
                    var message = $("textarea#message").val();
                    var firstName = name; // For Success/Failure Message
                    // Check for white space in name for Success/Fail message
                    if (firstName.indexOf(' ') >= 0) {
                        firstName = name.split(' ').slice(0, -1).join(' ');
                    }
                    $this = $("#sendMessageButton");
                    $this.prop("disabled", true); // Disable submit button until AJAX call is complete to prevent duplicate messages
                    loadSend();
                    $.ajax({
                        url: "{% url 'blog:contact' %}",
                        type: "POST",
                        dataType: 'json',
                        data: {
                            name: name,
                            phone: phone,
                            email: email,
                            message: message,
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                        },
                        cache: false,
                        success: function (result) {
                            if (result.status === 200) {
                                // Success message
                                $('#success').html("<div class='alert alert-success'>");
                                $('#success > .alert-success').html("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;")
                                    .append("</button>");
                                $('#success > .alert-success')
                                    .append("<strong>Your message has been sent. </strong>");
                                $('#success > .alert-success')
                                    .append('</div>');
                                //clear all fields
                                $('#contactForm').trigger("reset");
                            } else {
                                $('#success').html("<div class='alert alert-danger'>");
                                $('#success > .alert-danger').html("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;")
                                    .append("</button>");
                                $('#success > .alert-danger').append($("<strong>").text(result.data));
                                $('#success > .alert-danger').append('</div>');
                            }
                        },
                        /*
                        error: function () {
                            // Fail message
                            $('#success').html("<div class='alert alert-danger'>");
                            $('#success > .alert-danger').html("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;")
                                .append("</button>");
                            $('#success > .alert-danger').append($("<strong>").text("Sorry " + firstName + ", it seems that my mail server is not responding. Please try again later!"));
                            $('#success > .alert-danger').append('</div>');
                            //clear all fields
                            $('#contactForm').trigger("reset");
                        },
                        */
                        complete:

                            function () {
                                setTimeout(function () {
                                    $this.prop("disabled", false); // Re-enable submit button when AJAX call is complete
                                }, 1000);
                            }
                    });
                },
                filter:

                    function () {
                        return $(this).is(":visible");
                    }

                ,
            })
            ;
            $("a[data-toggle=\"tab\"]").click(function (e) {
                e.preventDefault();
                $(this).tab("show");
            });
        })
        ;
        /*When clicking on Full hide fail/success boxes */
        $('#name').focus(function () {
            $('#success').html('');
        });
    </script>
{% endblock %}